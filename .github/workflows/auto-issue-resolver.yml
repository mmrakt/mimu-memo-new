name: Auto Issue Resolver

on:
  schedule:
    # JST 23:00-06:00ã®é–“ã€30åˆ†ã”ã¨ã«å®Ÿè¡Œ
    - cron: '0,30 14-20 * * *'  # UTC 14:00-20:30 (JST 23:00-05:30)
    - cron: '0 21 * * *'        # UTC 21:00 (JST 06:00)
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œ

jobs:
  process-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Find and process highest priority issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const priorities = ['high', 'middle', 'low'];
            const processedLabel = 'claude-code-requested';
            
            console.log('ğŸ” Searching for unprocessed issues...');
            
            for (const priority of priorities) {
              console.log(`Checking ${priority} priority issues`);
              
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: priority,
                state: 'open',
                sort: 'created',
                direction: 'desc',
                per_page: 10
              });
              
              // æœªå‡¦ç†ã®issueã‚’æ¢ã™
              const unprocessedIssue = issues.data.find(issue => 
                !issue.labels.some(label => label.name === processedLabel)
              );
              
              if (unprocessedIssue) {
                console.log(`âœ… Found issue #${unprocessedIssue.number}: ${unprocessedIssue.title}`);
                
                // @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: unprocessedIssue.number,
                  body: [
                    `@claude ã“ã®Issue #${unprocessedIssue.number} ã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚`,
                    '',
                    `**ã‚¿ã‚¤ãƒˆãƒ«**: ${unprocessedIssue.title}`,
                    `**å„ªå…ˆåº¦**: ${priority}`,
                    '',
                    '**èª¬æ˜**:',
                    unprocessedIssue.body || 'èª¬æ˜ãªã—',
                    '',
                    'å…·ä½“çš„ãªå®Ÿè£…æ–¹é‡ã¨å¿…è¦ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚'
                  ].join('\n')
                });
                
                // å‡¦ç†æ¸ˆã¿ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: unprocessedIssue.number,
                  labels: [processedLabel]
                });
                
                console.log('ğŸ‰ Claude mention comment posted');
                return; // 1ã¤å‡¦ç†ã—ãŸã‚‰çµ‚äº†
              }
            }
            
            console.log('â„¹ï¸ No unprocessed issues found');
